<!DOCTYPE html>
<html lang="ja">
<head>
　<div id="score" style="width: 500px; height: 200px;"></div>
  <meta charset="UTF-8">
  <title>音程当てゲーム</title>
  <script src="https://unpkg.com/vexflow/releases/vexflow-debug.js"></script>
  <div id="score" style="width: 500px; height: 200px;"></div>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #score { border: 1px solid #ccc; margin: 20px 0; }
    select, button { font-size: 16px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>音程当てゲーム</h1>
  <div id="score"></div>

  <label>数字:
    <select id="numberSelect">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
    </select>
  </label>

  <label>修飾語:
    <select id="qualitySelect">
      <option value="完全">完全</option>
      <option value="長">長</option>
      <option value="短">短</option>
      <option value="増">増</option>
      <option value="減">減</option>
      <option value="重増">重増</option>
      <option value="重減">重減</option>
    </select>
  </label>

  <button onclick="checkAnswer()">判定</button>
  <p id="result"></p>

  <audio id="correctSound" src="correct.mp3"></audio>
  <audio id="wrongSound" src="wrong.mp3"></audio>

  <script>
    const VF = Vex.Flow;
    const notesList = ["c", "d", "e", "f", "g", "a", "b"];
    const accidentals = ["", "#", "b", "##", "bb", "n"];
    let note1, note2;

    function getRandomNote() {
      const note = notesList[Math.floor(Math.random() * notesList.length)];
      const acc = accidentals[Math.floor(Math.random() * accidentals.length)];
      const octave = Math.floor(Math.random() * 2) + 3;
      return { key: note + "/" + octave, accidental: acc };
    }

    function renderNotes() {
      note1 = getRandomNote();
      note2 = getRandomNote();

      const div = document.getElementById("score");
      div.innerHTML = "";

      const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
      renderer.resize(300, 200);
      const context = renderer.getContext();
      const stave = new VF.Stave(10, 40, 250);
      stave.addClef("treble").setContext(context).draw();

      const vnote1 = new VF.StaveNote({ clef: "treble", keys: [note1.key], duration: "w" });
      const vnote2 = new VF.StaveNote({ clef: "treble", keys: [note2.key], duration: "w" });

      if (note1.accidental) vnote1.addAccidental(0, new VF.Accidental(note1.accidental));
      if (note2.accidental) vnote2.addAccidental(0, new VF.Accidental(note2.accidental));

      const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
      voice.addTickables([vnote1, vnote2]);

      new VF.Formatter().joinVoices([voice]).format([voice], 200);
      voice.draw(context, stave);
    }

    function getSemitone(note) {
      const [letter, octave] = note.key.split("/");
      const base = { c: 0, d: 2, e: 4, f: 5, g: 7, a: 9, b: 11 }[letter];
      const acc = note.accidental;
      const octaveOffset = parseInt(octave) * 12;
      const accidentalOffset = { "": 0, "#": 1, "##": 2, "b": -1, "bb": -2, "n": 0 }[acc] || 0;
      return base + accidentalOffset + octaveOffset;
    }

    function getIntervalQuality(semitones, degree) {
      const expected = {
        1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11,
        8: 12, 9: 14, 10: 16, 11: 17, 12: 19, 13: 21
      };

      const ideal = expected[degree];
      const diff = semitones - ideal;

      const isPerfect = [1, 4, 5, 8].includes(degree);
      if (isPerfect) {
        if (diff === 0) return "完全";
        if (diff === 1) return "増";
        if (diff === 2) return "重増";
        if (diff === -1) return "減";
        if (diff === -2) return "重減";
      } else {
        if (diff === 0) return "長";
        if (diff === -1) return "短";
        if (diff === 1) return "増";
        if (diff === 2) return "重増";
        if (diff === -2) return "重減";
        if (diff === -3) return "減";
      }
      return "不明";
    }

    function checkAnswer() {
      const numSelect = parseInt(document.getElementById("numberSelect").value);
      const qualSelect = document.getElementById("qualitySelect").value;

      const semitone1 = getSemitone(note1);
      const semitone2 = getSemitone(note2);
      const distance = semitone2 - semitone1;

      const degree = ((notesList.indexOf(note2.key[0]) - notesList.indexOf(note1.key[0]) + 7) % 7) + 1
                   + (parseInt(note2.key.split("/")[1]) - parseInt(note1.key.split("/")[1])) * 7;

      const quality = getIntervalQuality(distance, degree);

      const correct = (numSelect === degree && qualSelect === quality);
      const result = document.getElementById("result");
      const correctSound = document.getElementById("correctSound");
      const wrongSound = document.getElementById("wrongSound");

      if (correct) {
        result.textContent = `正解！（${quality}${degree}度）`;
        correctSound.play();
      } else {
        result.textContent = `不正解。正解は ${quality}${degree}度`;
        wrongSound.play();
      }

      setTimeout(renderNotes, 2000); // 2秒後に次の問題
    }

    renderNotes(); // 初回表示
  </script>
</body>
</html>
